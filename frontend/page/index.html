<!DOCTYPE HTML>
<!-- html ì´ë™ ë˜ëŠ” ê³³ì€ ì£¼ì°¨ì¥ íŒì—…, ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
<html>
<head>
    <title>ì£¼ì°¨ì‡ìŠˆ</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="assets/css/main.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- marker cluster css -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/css/ol.css" type="text/css">
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/build/ol.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- marker cluster -->
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
</head>
<body class="is-preload">
    <!-- Wrapper -->
    <div id="wrapper">

        <!-- Header -->
        <header id="header">
            <div class="inner">
                <!-- Logo and Search Bar Container -->
                <div class="logo-container">
                    <a href="index.html" class="logo">
                        <span class="symbol"><img src="images/ìë™ì°¨.gif" alt="" /></span><span class="title">ì£¼ì°¨ì‡ìŠˆ</span>
                    </a>
                    <!-- Search Bar -->
                    <div class="search-bar-container">
                        <img src="images/ë‹ë³´ê¸°.png" alt="ê²€ìƒ‰ ì•„ì´ì½˜" class="search-icon" />
                        <form class="search-form" onsubmit="return false;"> 
                            <input type="text" class="search-bar" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                            <div class="search-buttons">
                                <button type="button" class="voice-search-btn" title="ìŒì„± ê²€ìƒ‰">
                                    <img src="images/microphone.png" alt="ìŒì„± ê²€ìƒ‰ ì•„ì´ì½˜" class="voice-search-icon" />
                                </button>
                                <button type="button" class="search-button" title="ê²€ìƒ‰">ğŸ”</button>    
                            </div>
                        </form>
                        <div class="suggestions"></div>
                    </div>
                    <div class="trending-searches">
                </div>
            </div>
        </header>

        <!-- Main -->
        <div id="main">
            <div class="inner">
                <!-- ì§€ë„ ì„¹ì…˜ -->
                <div class="parking-info-container">
                    <div class="map-section" style="position: relative;">
                        <!-- Leaflet ì§€ë„ë¥¼ í‘œì‹œí•  div -->
                        <div id="map" style="position: relative; width: 100vw; height: 76vh;"></div>
                        <button id="find-me" style="position: absolute; bottom: 20px; right: 20px; width: 60px; height: 60px; padding: 0; border: none; border-radius: 8px; z-index: 1000;">
                            <img src="images/naver.png" style="width: 100%; height: 100%; object-fit: cover;">
                        </button>
                    </div>
                </div>
                <div id="status"></div>
                <a id="map-link" href="" target="_blank"></a>
            </div>
        </div>
        <!-- ë„¤ë¹„ê²Œì´ì…˜ ìë¦¬ -->
        <div class="navi">
            <div class="navi-section">
                <nav class="navbar">
                    <ul>
                        <!-- í™ˆìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨ -->
                        <li><a href="index.html"><img src="images/sweethome.png" alt="Home" /> HOME</a></li>
                        <!-- hot place ê²Œì‹œíŒ ì´ë™ -->
                        <li><a href="party.html"><img src="images/hotplace.png" alt="About" /> HOT PLACE</a></li>
                        <!-- ì¦ê²¨ì°¾ê¸° í˜ì´ì§€ ì´ë™ -->
                        <li><a href="favor/favor.html"><img src="images/bookmark.png" alt="Services" /> BOOKMARKS</a></li>
                        <!-- ê°œì¸ í”„ë¡œí•„ í˜ì´ì§€ ì´ë™ -->
                        <li><a href="./mypage/personal/index.html"><img src="images/mypage.png" alt="Contact" /> MY PAGE</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    <!-- ê²€ìƒ‰ì°½ ê¸°ëŠ¥ -->
    <script src="assets/js/form.js"></script>
    <!-- voice search -->
    <script src="assets/js/voice-search.js"></script>
    <!-- Initialize the Leaflet Map -->
    <script>
        // var markers = L.markerClusterGroup();

        function addParkingMarkers(parkingData) {  // ì£¼ë³€ ì£¼ì°¨ì¥ ë°ì´í„° ê°€ì ¸ì™€ì„œ
            var parkIcon = L.icon({
                    iconUrl: 'images/parkingarea.png', // ì‚¬ìš©í•  ì´ë¯¸ì§€ íŒŒì¼ ê²½ë¡œ
                    iconSize: [42, 42], // ì•„ì´ì½˜ í¬ê¸° (í”½ì…€)
                    iconAnchor: [16, 32], // ì•„ì´ì½˜ì˜ 'í•€ì´ ì°íˆëŠ”' ì§€ì  (ê°€ìš´ë° ì•„ë˜)
                    popupAnchor: [0, -32] // íŒì—… ìœ„ì¹˜ (ì•„ì´ì½˜ ìœ„ìª½)
                });
            parkingData.forEach(function(parking) {  // for ë°˜ë³µë¬¸
                var marker = L.marker([parking.park_la, parking.park_lo], { icon: parkIcon }).addTo(map); 
                // marker.bindPopup(`<b>${parking.park_nm}</b><br>${parking.park_addr}`); 
                // í´ë¦­ì´ ì¼ì–´ë‚  ê²½ìš° ì£¼ì°¨ì¥ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
                marker.on('click', function() {
                    // ì›í•˜ëŠ” HTML í˜ì´ì§€ë¡œ ì´ë™
                    window.location.href = 'parkinginfo.html';
                });
                // markers.addLayer(marker);
            });
            // map.addLayer(markers);
        }
        // fastapië¡œ ê°’ ë³´ë‚´ê¸°
        function fetchParkingData(latitude, longitude) {
            const url = `http://localhost:8000/location?latitude=${latitude}&longitude=${longitude}`;
            fetch(url, {  // FastAPI ì—”ë“œí¬ì¸íŠ¸ URL / fetchëŠ” ë¹„ë™ê¸° ë°©ì‹
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                console.log('Success:', data);
                addParkingMarkers(data);
            })
            .catch(error => console.error('Error:', error));
        }
        // ì§€ë„ ì´ˆê¸°í™” (ì„œìš¸ ì¢Œí‘œ ë° ì¤Œ ë ˆë²¨ ì„¤ì •)
        var map = L.map('map').setView([37.5665, 126.9780], 15);

        // vworld íƒ€ì¼ ë ˆì´ì–´ ì¶”ê°€
        L.tileLayer('http://xdworld.vworld.kr:8080/2d/Base/202002/{z}/{x}/{y}.png', {
            maxZoom: 21,
            attribution: 'Â© VWorld'
        }).addTo(map);
        // ê¸°ë³¸ ì§€ë„ ì“°ë˜ ë²„ì „
        /*
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 21,
            attribution: 'Â© OpenStreetMap'
        }).addTo(map); */

        // GeoFindMe í•¨ìˆ˜ - í˜„ì¬ ìœ„ì¹˜ ì°¾ê¸°
        function geoFindMe() {
            const status = document.querySelector("#status");
            const mapLink = document.querySelector("#map-link");

            mapLink.href = "";

            function success(position) {
                // const latitude = position.coords.latitude;
                // const longitude = position.coords.longitude;

                // ì„œìš¸ì´ ì—†ëŠ” ê´€ê³„ë¡œ ì ì‹œ ìˆ˜ì›ì‹œì²­ ê¸°ì¤€ìœ¼ë¡œ ì‹œì‘
                // const latitude = 37.2635846787744;
                // const longitude = 127.028715898311;

                const latitude = 35.5444169723408;
                const longitude = 129.331864527424;

                // ìƒíƒœ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
                status.textContent = "";
                mapLink.href = `http://map.vworld.kr/map/maps.do?centerLon=${longitude}&centerLat=${latitude}&zoom=18`;

                // ë‚´ ìœ„ì¹˜ ì•„ì´ì½˜
                var customIcon = L.icon({
                    iconUrl: 'images/my-location.png', // ì‚¬ìš©í•  ì´ë¯¸ì§€ íŒŒì¼ ê²½ë¡œ
                    iconSize: [42, 42], // ì•„ì´ì½˜ í¬ê¸° (í”½ì…€)
                    iconAnchor: [16, 32], // ì•„ì´ì½˜ì˜ 'í•€ì´ ì°íˆëŠ”' ì§€ì  (ê°€ìš´ë° ì•„ë˜)
                    popupAnchor: [0, -32] // íŒì—… ìœ„ì¹˜ (ì•„ì´ì½˜ ìœ„ìª½)
                });

                // ìœ„ë„ì™€ ê²½ë„ë¥¼ FastAPIë¡œ ì „ì†¡
                fetchParkingData(latitude, longitude);

                // ì§€ë„ì— ì»¤ìŠ¤í…€ ì•„ì´ì½˜ì„ ì‚¬ìš©í•˜ëŠ” ë§ˆì»¤ ì¶”ê°€
                // ì•„ë˜ì²˜ëŸ¼ markerë¥¼ ë³€ìˆ˜ ì§€ì •í•´ì£¼ê³ 
                // ì£¼ì°¨ì¥ markerëŠ” ë”°ë¡œ parking_marker ë¡œ ë³€ìˆ˜ ë„£ìœ¼ë©´ ë ë“¯
                var marker = L.marker([latitude, longitude], { icon: customIcon }).addTo(map)

                // ì§€ë„ì—ì„œ í˜„ì¬ ìœ„ì¹˜ì— ë§ˆì»¤ ì¶”ê°€
                // var marker = L.marker([latitude, longitude]).addTo(map);
                // markerì— íŒì—… ìƒì„±
                // marker.bindPopup("<b>ë‚´ ìœ„ì¹˜</b>").openPopup();

                // ì§€ë„ ì¤‘ì‹¬ì„ í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™
                map.setView([latitude, longitude], 16);

                map.invalidateSize(); // ì§€ë„ í¬ê¸° ê°±ì‹  (ë¦¬ì‚¬ì´ì§• ë¬¸ì œ ë°©ì§€)
            }

            function error() {
                status.textContent = "Unable to retrieve your location";
            }

            var options = {
                enableHighAccuracy: true, // ëª¨ë°”ì¼ì—ì„œëŠ” gps
                maximumAge: 0, // í•­ìƒ ìµœì‹  ìœ„ì¹˜ ì •ë³´ ìš”ì²­
                timeout: 5000 // ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ìµœëŒ€ ì‹œê°„ 5ì´ˆ ë„˜ìœ¼ë©´ ì˜¤ë¥˜ë©”ì‹œì§€
            }

            if (!navigator.geolocation) {
                status.textContent = "Geolocation is not supported by your browser";
            } else {
                status.textContent = "Locatingâ€¦";
                // ìœ„ì¹˜ë³€ê²½ë ë•Œë§ˆë‹¤ í•¨ìˆ˜í˜¸ì¶œí•´ì„œ ë‚´ ìœ„ì¹˜ ìµœì‹ í™”
                navigator.geolocation.watchPosition(success, error, options);
                // navigator.geolocation.getCurrentPosition(success, error, options);
            }
        }

        // ì›¹ ì‹œì‘í•˜ìë§ˆì í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™!
        window.onload = geoFindMe;
        // "ë‚´ ìœ„ì¹˜ ì°¾ê¸°" ë²„íŠ¼ í´ë¦­ ì‹œ geoFindMe í•¨ìˆ˜ ì‹¤í–‰í•˜ë©° ì§€ë„ ìƒˆë¡œê³ ì¹¨
        document.querySelector("#find-me").addEventListener("click", function() {
            // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            location.reload();
        });
    </script>
</body>
</html>
