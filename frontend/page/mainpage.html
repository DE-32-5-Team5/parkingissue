<!DOCTYPE HTML>
<!-- html ì´ë™ ë˜ëŠ” ê³³ì€ ì£¼ì°¨ì¥ íŒì—…, ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
<html>
<head>
    <title>ì£¼ì°¨ì‡ìŠˆ</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" /> 
    <link rel="stylesheet" href="assets/css/main.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="icon" href="images/parkingissue-favicon-16x16.png"/>
    <link rel="apple-touch-icon" href="images/parkingissue-apple-icon.png"/>
    <!-- marker cluster css -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/css/ol.css" type="text/css">
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/build/ol.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- marker cluster -->
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
</head>
<body class="is-preload">
    <!-- Wrapper -->
    <div id="wrapper">

        <!-- Header -->
        <header id="header">
            <div class="inner">
                <!-- Logo and Search Bar Container -->
                <div class="logo-container">
                    <a href="mainpage.html" class="logo">
                        <span class="symbol"><img src="images/ìë™ì°¨.gif" alt="" /></span><span class="title">ì£¼ì°¨ì‡ìŠˆ</span>
                    </a>
                    <!-- Search Bar -->
                    <div class="search-bar-container">
                        <img src="images/ë‹ë³´ê¸°.png" alt="ê²€ìƒ‰ ì•„ì´ì½˜" class="search-icon" />
                        <!-- ì—¬ê¸°ì—ì„œ ì´ë²¤íŠ¸ ëª‡ê°œ ì¶”ê°€ search.js ì— ìˆìŒ -->
                        <form class="search-form" onsubmit="handleSearch(event); return false;"> 
                            <input type="text" class="search-bar" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                            <div class="search_class">
                                <form action="#">
                                    <label for="parkhot">ê²€ìƒ‰êµ¬ë¶„</label>
                                    <select name="parkorhot" id="parkhot">
                                    <option value="addr">ì£¼ì†Œ</option>
                                    <option value="park">ì£¼ì°¨ì¥</option>
                                    <option value="hotplace">í•«í”Œ</option>
                                    </select>
                                </form>
                            </div>
                            <div class="search-buttons">
                                <button type="button" class="voice-search-btn" title="ìŒì„± ê²€ìƒ‰">
                                    <img src="images/microphone.png" alt="ìŒì„± ê²€ìƒ‰ ì•„ì´ì½˜" class="voice-search-icon" />
                                </button>
                                <button type="button" class="search-button" title="ê²€ìƒ‰" onclick="handleSearch(event)">ğŸ”</button>    
                            </div>
                        </form>
                        <div class="suggestions"></div>
                    </div>
                    <div class="trending-searches">
                </div>
            </div>
        </header>

        <!-- Main -->
        <div id="main">
            <div class="inner">
                <!-- ì§€ë„ ì„¹ì…˜ -->
                <div class="parking-info-container">
                    <div class="map-section" style="position: relative;">
                        <!-- Leaflet ì§€ë„ë¥¼ í‘œì‹œí•  div -->
                        <div id="map" style="position: relative; width: 100vw; height: 76vh;"></div>
                        <button id="find-me" style="position: absolute; bottom: 20px; right: 20px; width: 60px; height: 60px; padding: 0; border: none; border-radius: 8px; z-index: 1000;">
                            <img src="images/naver.png" style="width: 100%; height: 100%; object-fit: cover;">
                        </button>
                        <button id="research" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 10px 20px; border: none; border-radius: 25px; background-color: #4285F4; color: white; font-size: 14px; font-weight: bold; letter-spacing: 0px; display: none; align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 1000; cursor: pointer; width: 170px;">
                            <img src="images/research_icon.png" alt="reload-icon" style="width: 16px; height: 16px; margin-right: 8px;">
                            í˜„ ì§€ë„ì—ì„œ ê²€ìƒ‰
                        </button>
                    </div>
                </div>
                <div id="status"></div>
                <a id="map-link" href="" target="_blank"></a>
            </div>
        </div>
        <!-- ë„¤ë¹„ê²Œì´ì…˜ ìë¦¬ -->
        <div class="navi">
            <div class="navi-section">
                <nav class="navbar">
                    <ul>
                        <!-- í™ˆìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨ -->
                        <li><a href="mainpage.html"><img src="images/sweethome.png" alt="Home" /> HOME</a></li>
                        <!-- hot place ê²Œì‹œíŒ ì´ë™ -->
                        <li><a href="party.html"><img src="images/hotplace.png" alt="About" /> HOT PLACE</a></li>
                        <!-- ì¦ê²¨ì°¾ê¸° í˜ì´ì§€ ì´ë™ -->
                        <li><a href="favor.html"><img src="images/bookmark.png" alt="Services" /> BOOKMARKS</a></li>
                        <!-- ê°œì¸ í”„ë¡œí•„ í˜ì´ì§€ ì´ë™ -->
                        <li><a href="personal_mypage.html"><img src="images/mypage.png" alt="Contact" /> MY PAGE</a></li>
                    </ul>
                </nav>
            </div>
        </div>
        <script>
            const mypageLink = document.querySelector('.navi a[href="personal_mypage.html"]');
            const apiUrl = '/api/login/isuser';
            window.addEventListener('load', () => {
                fetch(apiUrl, { 
                    method: 'POST' 
                })
                .then(response => response.json())
                .then(data => {
                    const userType = data.user_type; 

                    if (userType === 1) {
                        mypageLink.href = 'personal_mypage.html';
                    } else if (userType === 2) {
                        mypageLink.href = 'enterprise_mypage.html';
                    } else {
                        console.error('ì•Œ ìˆ˜ ì—†ëŠ” ì‚¬ìš©ì ìœ í˜•ì…ë‹ˆë‹¤.');
                    }
                })
                .catch(error => {
                    console.error('API í˜¸ì¶œ ì—ëŸ¬:', error);
                });
            });
        </script>
    <script src="assets/js/checkAuth.js"></script>
    <!-- voice search -->
    <script src="assets/js/voice-search.js"></script>
    <script>
        window.addEventListener("load", () => {
            setTimeout(() => {
                if (window.pageYOffset === 0) {
                    window.scrollTo(0, 1);
                }
            }, 1000);
        });
    </script>
    <!-- Initialize the Leaflet Map -->
    <script>
        // ì§€ë„ ì¤‘ì‹¬ì˜ ìœ„ë„, ê²½ë„ë¥¼ ì–»ëŠ” í•¨ìˆ˜
        // ì´ ìœ„ì¹˜ì—ì„œ ì£¼ë³€ ê²€ìƒ‰ì„ ìœ„í•œ í•¨ìˆ˜
        function getMapCenter() {
            var center = map.getCenter();  // í˜„ì¬ ì§€ë„ ì¤‘ì‹¬ ì¢Œí‘œ ë°˜í™˜
            var cen_latitude = center.lat;     // ìœ„ë„
            var cen_longitude = center.lng;    // ê²½ë„

            return { cen_latitude, cen_longitude };
        }
        
        var parkIcon = L.icon({
                    iconUrl: 'images/parkingarea.png', // ì‚¬ìš©í•  ì´ë¯¸ì§€ íŒŒì¼ ê²½ë¡œ
                    iconSize: [42, 42], // ì•„ì´ì½˜ í¬ê¸° (í”½ì…€)
                    iconAnchor: [16, 32], // ì•„ì´ì½˜ì˜ 'í•€ì´ ì°íˆëŠ”' ì§€ì  (ê°€ìš´ë° ì•„ë˜)
                    popupAnchor: [0, -32] // íŒì—… ìœ„ì¹˜ (ì•„ì´ì½˜ ìœ„ìª½)
                });

        var hotIcon = L.icon({
                    iconUrl: 'images/hotplace-icon.png', // ì‚¬ìš©í•  ì´ë¯¸ì§€ íŒŒì¼ ê²½ë¡œ
                    iconSize: [42, 42], // ì•„ì´ì½˜ í¬ê¸° (í”½ì…€)
                    iconAnchor: [16, 32], // ì•„ì´ì½˜ì˜ 'í•€ì´ ì°íˆëŠ”' ì§€ì  (ê°€ìš´ë° ì•„ë˜)
                    popupAnchor: [0, -32] // íŒì—… ìœ„ì¹˜ (ì•„ì´ì½˜ ìœ„ìª½)
                });

        // ì£¼ì°¨ì¥ ë§ˆì»¤ ì°ê¸°
        function addParkingMarkers(parkingData) {  // ì£¼ë³€ ì£¼ì°¨ì¥ ë°ì´í„° ê°€ì ¸ì™€ì„œ
            markers.clearLayers();
            parkingData.forEach(function(parking) {  // for ë°˜ë³µë¬¸
                var marker = L.marker([parking.park_la, parking.park_lo], { icon: parkIcon }).addTo(markers); 
                // marker.bindPopup(`<b>${parking.park_nm}</b><br>${parking.park_addr}`); 
                // í´ë¦­ì´ ì¼ì–´ë‚  ê²½ìš° ì£¼ì°¨ì¥ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
                marker.on('click', function() {
                    const parkla = encodeURIComponent(parking.park_la);
                    const parklo = encodeURIComponent(parking.park_lo);
                    const parkid = encodeURIComponent(parking.park_id);
                    const parknm = encodeURIComponent(parking.park_nm);
                    const parkaddr = encodeURIComponent(parking.park_addr);
                    // ì›í•˜ëŠ” HTML í˜ì´ì§€ë¡œ ì´ë™
                    window.location.href = `parkinginfo.html?parkid=${parkid}&parknm=${parknm}&parkaddr=${parkaddr}&lat=${parkla}&lon=${parklo}`;
                });
                // markers.addLayer(marker);
            });
            // map.addLayer(markers);
        }
        function fetchAndProcessParkingData(latitude, longitude) {
            const postUrl = 'https://parkingissue.online/api/location'; // POST ìš”ì²­ URL
            const getUrl = 'https://parkingissue.online/api/frontget/'; // GET ìš”ì²­ URL

            // FastAPIì— ë°ì´í„° POST ìš”ì²­
            return fetch(postUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    latitude: latitude,
                    longitude: longitude,
                }),
            })
            .then(postResponse => {
                if (!postResponse.ok) {
                    throw new Error(`POST Request failed: ${postResponse.status}`);
                }
                console.log('POST ìš”ì²­ ì„±ê³µ');
                return new Promise(resolve => setTimeout(resolve, 2500));
            })
            .then(() => fetch(getUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    cache: "no-store",
            }))  
            .then(getResponse => {
                if (!getResponse.ok) {
                    throw new Error(`GET Request failed: ${getResponse.status}`);
                }
                return getResponse.json();
            })
            .then(data => {
                if (data.stored_data) {
                    console.log('GET ìš”ì²­ ì„±ê³µ, ë°ì´í„°:', data.stored_data);
                    return data.stored_data;
                } else {
                    markers.clearLayers();
                    throw new Error('No data received.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        // ì§€ë„ ì´ˆê¸°í™” (ì„œìš¸ ì¢Œí‘œ ë° ì¤Œ ë ˆë²¨ ì„¤ì •)
        var map = L.map('map').setView([37.5665, 126.9780], 16);
        window.map = map;

        var markers = L.layerGroup().addTo(map);
        var hotmarkers = L.layerGroup().addTo(map);

        L.tileLayer('https://xdworld.vworld.kr/2d/Base/202002/{z}/{x}/{y}.png', {
            maxZoom: 21,
            attribution: 'Â© VWorld'
        }).addTo(map);
        // í˜„ ìœ„ì¹˜ ì¬ê²€ìƒ‰ ë²„íŠ¼
        const researchButton = document.getElementById("research");

        // ì´ˆê¸° ì¤‘ì‹¬ ì¢Œí‘œ
        // ì´ê±° ì´ìš©í•´ì„œ ë‚´ ìœ„ì¹˜ ì£¼ë³€ 500m í• ë•Œë„ ì²˜ìŒ í•œë²ˆë§Œ ì¡°íšŒí•˜ê²Œ í•˜ê³ 
        // ê·¸ ë‹¤ìŒë¶€í„°ëŠ” ì´ë™ ê±°ë¦¬ë‘ ë¹„êµí•´ì„œ ë©€ì–´ì¡Œì„ë•Œ ì¬ê²€ìƒ‰í•˜ê²Œ í•˜ë©´ ë ë“¯
        let initialCenter = null;

        let lastFetchedTime = 0; // ë§ˆì§€ë§‰ìœ¼ë¡œ ìš”ì²­ì„ ë³´ë‚¸ ì‹œê°„
        const FETCH_INTERVAL = 2000; // 10ì´ˆ ê°„ê²©ìœ¼ë¡œ ìš”ì²­ (10000ms)
        
        // watchPositionì˜ ID
        let watchId = null;

        // GeoFindMe í•¨ìˆ˜ - í˜„ì¬ ìœ„ì¹˜ ì°¾ê¸°
        function geoFindMe() {
            const status = document.querySelector("#status");
            const mapLink = document.querySelector("#map-link");

            mapLink.href = "";

            let currentMarker = null;
            let isFirstUpdate = true;

            function success(position) {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;

                // ì„œìš¸ì´ ì—†ëŠ” ê´€ê³„ë¡œ ì ì‹œ ìˆ˜ì›ì‹œì²­ ê¸°ì¤€ìœ¼ë¡œ ì‹œì‘
                // const latitude = 37.2635846787744;
                // const longitude = 127.028715898311;
                
                // ìš¸ì‚°
                // const latitude = 35.5444169723408;
                // const longitude = 129.331864527424;

                // ìƒíƒœ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
                status.textContent = "";
                mapLink.href = `https://map.vworld.kr/map/maps.do?centerLon=${longitude}&centerLat=${latitude}&zoom=18`;

                // ë‚´ ìœ„ì¹˜ ì•„ì´ì½˜
                var customIcon = L.icon({
                    iconUrl: 'images/my-location.png', // ì‚¬ìš©í•  ì´ë¯¸ì§€ íŒŒì¼ ê²½ë¡œ
                    iconSize: [42, 42], // ì•„ì´ì½˜ í¬ê¸° (í”½ì…€)
                    iconAnchor: [16, 32], // ì•„ì´ì½˜ì˜ 'í•€ì´ ì°íˆëŠ”' ì§€ì  (ê°€ìš´ë° ì•„ë˜)
                    popupAnchor: [0, -32] // íŒì—… ìœ„ì¹˜ (ì•„ì´ì½˜ ìœ„ìª½)
                });

                // ìœ„ì¹˜ ì—…ë°ì´íŠ¸ ì‹œ FastAPIì— ìš”ì²­ì„ ì£¼ê¸°ì ìœ¼ë¡œ ë³´ë‚´ê¸°
                const currentTime = Date.now();
                if (currentTime - lastFetchedTime >= FETCH_INTERVAL) {
                    // ì¼ì • ì‹œê°„ ê°„ê²©ì´ ì§€ë‚œ ê²½ìš°ì—ë§Œ ìš”ì²­
                    hotmarkers.clearLayers();
                    fetchAndProcessParkingData(latitude, longitude)
                        .then(parkingData => {
                            if (parkingData) {
                                console.log("ì£¼ì°¨ì¥ ë°ì´í„°:", parkingData);
                                addParkingMarkers(parkingData); // ë°›ì€ ë°ì´í„°ë¥¼ ì§€ë„ì— ë§ˆì»¤ë¡œ ì¶”ê°€
                            } else {
                                console.error("ì£¼ì°¨ì¥ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                            }
                        })
                        .catch(error => console.error("Error:", error));
                        lastFetchedTime = currentTime; // ìš”ì²­ ë³´ë‚¸ ì‹œê°„ì„ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ê°±ì‹ 
                    }

                // ì§€ë„ì— ì»¤ìŠ¤í…€ ì•„ì´ì½˜ì„ ì‚¬ìš©í•˜ëŠ” ë§ˆì»¤ ì¶”ê°€
                // ë‚´ ìœ„ì¹˜ ë§ˆì»¤ ì²˜ë¦¬
                if (!currentMarker) {
                    // ìµœì´ˆ ë§ˆì»¤ ìƒì„±
                    currentMarker = L.marker([latitude, longitude], { icon: customIcon }).addTo(map);
                } else {
                    // ë§ˆì»¤ ìœ„ì¹˜ë§Œ ì—…ë°ì´íŠ¸
                    currentMarker.setLatLng([latitude, longitude]);
                }

                // ì§€ë„ ì¤‘ì‹¬ì„ í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™
                if (isFirstUpdate) {
                    map.setView([latitude, longitude], map.getZoom());
                    initialCenter = map.getCenter();
                    isFirstUpdate = false;
                }

                map.invalidateSize(); // ì§€ë„ í¬ê¸° ê°±ì‹  (ë¦¬ì‚¬ì´ì§• ë¬¸ì œ ë°©ì§€)
            }

            function error() {
                status.textContent = "Unable to retrieve your location";
            }

            var options = {
                enableHighAccuracy: true, // ëª¨ë°”ì¼ì—ì„œëŠ” gps
                maximumAge: 0, // í•­ìƒ ìµœì‹  ìœ„ì¹˜ ì •ë³´ ìš”ì²­
                timeout: 5000 // ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ìµœëŒ€ ì‹œê°„ 5ì´ˆ ë„˜ìœ¼ë©´ ì˜¤ë¥˜ë©”ì‹œì§€
            }

            if (!navigator.geolocation) {
                status.textContent = "Geolocation is not supported by your browser";
            } else {
                status.textContent = "Locatingâ€¦";
                // ìœ„ì¹˜ë³€ê²½ë ë•Œë§ˆë‹¤ í•¨ìˆ˜í˜¸ì¶œí•´ì„œ ë‚´ ìœ„ì¹˜ ìµœì‹ í™”
                watchId = navigator.geolocation.watchPosition(success, error, options);
                // navigator.geolocation.getCurrentPosition(success, error, options);
            }
        }
        
        // ì§€ë„ ì´ë™ ì‹œ ì¼ì–´ë‚˜ëŠ” ì´ë²¤íŠ¸
        map.on('moveend', function () {
            const currentCenter = map.getCenter(); // í˜„ì¬ ì§€ë„ ì¤‘ì‹¬ ì¢Œí‘œ
            if (initialCenter && !initialCenter.equals(currentCenter)) {
                researchButton.style.display = "flex"; // ì§€ë„ ì´ë™ ì‹œ ë²„íŠ¼ í‘œì‹œ
            } else {
                researchButton.style.display = "none"; // ì´ë™í•˜ì§€ ì•Šìœ¼ë©´ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            }
        });
        // í˜„ìœ„ì¹˜ ê²€ìƒ‰ì„ ëˆŒë €ì„ë•Œ ë°œìƒí•˜ëŠ” ì´ë²¤íŠ¸
        researchButton.addEventListener("click", function () {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId); // ìœ„ì¹˜ ì¶”ì  ì¤‘ì§€
                watchId = null; // ID ì´ˆê¸°í™”
            }
            const center = map.getCenter(); // í˜„ì¬ ì§€ë„ ì¤‘ì‹¬ ê°€ì ¸ì˜¤ê¸°
            hotmarkers.clearLayers();
            fetchAndProcessParkingData(center.lat, center.lng)
                .then(parkingData => {
                    if (parkingData) {
                        console.log("ì£¼ì°¨ì¥ ë°ì´í„°:", parkingData);
                        addParkingMarkers(parkingData); // ë°›ì€ ë°ì´í„°ë¥¼ ì§€ë„ì— ë§ˆì»¤ë¡œ ì¶”ê°€
                    } else {
                        console.error("ì£¼ì°¨ì¥ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                    }
                })
                .catch(error => console.error("Error:", error));
            initialCenter = map.getCenter(); // í˜„ì¬ ì¤‘ì‹¬ì„ ì´ˆê¸° ì¤‘ì‹¬ìœ¼ë¡œ ê°±ì‹ 
            researchButton.style.display = "none"; // ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        });

        // ì›¹ ì‹œì‘í•˜ìë§ˆì í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™!
        // window.onload = geoFindMe;
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const latitude = parseFloat(urlParams.get('lat'));
            const longitude = parseFloat(urlParams.get('lon'));
            const conid = urlParams.get('contentid')

            // URLì— ìœ„ê²½ë„ íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì§€ë„ ì´ë™
            if (latitude && longitude && conid) {
                if (watchId) { // í˜„ì¬ ìœ„ì¹˜ ì£¼ë³€ 500m ê²€ìƒ‰ ì¤‘ì§€
                            navigator.geolocation.clearWatch(watchId); // ìœ„ì¹˜ ì¶”ì  ì¤‘ì§€
                            watchId = null; // ID ì´ˆê¸°í™”
                        }
                // ìœ„ê²½ë„ê°€ ìˆë‹¤ë©´ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì§€ë„ ì´ë™
                hotmarkers.clearLayers();
                map.setView([latitude, longitude], 16); // 16ëŠ” ì¤Œ ë ˆë²¨
                // í•«í”Œ ë§ˆì»¤ ì°ê³ 
                var hotmarker = L.marker([latitude, longitude], { icon: hotIcon }).addTo(hotmarkers);
                hotmarker.on('click', function() {
                    const contenid = encodeURIComponent(conid) // url paramìœ¼ë¡œ contentid ê¹Œì§€
                    window.location.href = `post1.html?contentid=${contenid}`
                });
                fetchAndProcessParkingData(latitude, longitude) // ì£¼ë³€ 500m ì£¼ì°¨ì¥
                    .then(parkingData => {
                        if (parkingData) {
                            console.log("ì£¼ì°¨ì¥ ë°ì´í„°:", parkingData);
                            addParkingMarkers(parkingData); // ë°›ì€ ë°ì´í„°ë¥¼ ì§€ë„ì— ë§ˆì»¤ë¡œ ì¶”ê°€
                        } else {
                            console.error("ì£¼ì°¨ì¥ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                        }
                    })
                    .catch(error => console.error("Error:", error));
            } else {
                // ìœ„ê²½ë„ê°€ ì—†ë‹¤ë©´ ë‚´ ìœ„ì¹˜ ì°¾ê¸°
                geoFindMe();
            }
        };
        // "ë‚´ ìœ„ì¹˜ ì°¾ê¸°" ë²„íŠ¼ í´ë¦­ ì‹œ geoFindMe í•¨ìˆ˜ ì‹¤í–‰í•˜ë©° ì§€ë„ ìƒˆë¡œê³ ì¹¨
        document.querySelector("#find-me").addEventListener("click", function() {
            // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            history.replaceState({}, null, location.pathname);
            location.reload();
        });

        // ####################################### ê²€ìƒ‰ ##########################################

        let selectElement = null;
        let selectedValue = null;

        // ê²€ìƒ‰ì–´ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
        async function getSearchValue() {
            const searchInput = document.querySelector(".search-bar");
            return searchInput.value; // ê²€ìƒ‰ì–´ ê°’
        }

        // Enter í‚¤ ì…ë ¥ ë˜ëŠ” ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
        async function handleSearch(event) {
            event.preventDefault(); // ê¸°ë³¸ í¼ ì œì¶œ ë™ì‘ ë°©ì§€
            const searchValue = await getSearchValue();
        
            if (searchValue) {
                console.log("ê²€ìƒ‰ì–´ (Enter í‚¤):", searchValue);
                selectElement = document.getElementById("parkhot"); // select ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
                selectedValue = selectElement.value;
                // ê²€ìƒ‰ ë¡œì§ ì‹¤í–‰ (ì˜ˆ: API í˜¸ì¶œ)
                const enter_result = await performSearch(searchValue);
                console.log(enter_result);
                if (enter_result) {
                    if (watchId) { // í˜„ì¬ ìœ„ì¹˜ ì£¼ë³€ 500m ê²€ìƒ‰ ì¤‘ì§€
                            navigator.geolocation.clearWatch(watchId); // ìœ„ì¹˜ ì¶”ì  ì¤‘ì§€
                            watchId = null; // ID ì´ˆê¸°í™”
                        }
                    if (selectedValue == "park") {
                        // ì£¼ì°¨ì¥ì¸ ê²½ìš°ì—ëŠ” ì§€ë„ë§Œ ì˜®ê¸°ê³  ë§ˆí‚¹ë§Œ
                        markers.clearLayers(); // ê¸°ì¡´ ë§ˆì»¤ ì‚­ì œ
                        hotmarkers.clearLayers();
                        map.setView([enter_result.park_la, enter_result.park_lo], 16); // ì§€ë„ ìœ„ì¹˜ ì´ë™
                        var marker = L.marker([enter_result.park_la, enter_result.park_lo], { icon: parkIcon }).addTo(markers); // ë§ˆí‚¹
                        marker.on('click', function() {
                            const parkla = encodeURIComponent(enter_result.park_la);
                            const parklo = encodeURIComponent(enter_result.park_lo);
                            const parkid = encodeURIComponent(enter_result.park_id);
                            const parknm = encodeURIComponent(enter_result.park_nm);
                            const parkaddr = encodeURIComponent(enter_result.park_addr);
                            // ì›í•˜ëŠ” HTML í˜ì´ì§€ë¡œ ì´ë™
                            window.location.href = `parkinginfo.html?parkid=${parkid}&parknm=${parknm}&parkaddr=${parkaddr}&lat=${parkla}&lon=${parklo}`;
                        });
                    } else if (selectedValue == "hotplace"){ // í–‰ì‚¬ì¸ ê²½ìš°
                        if (watchId) { // í˜„ì¬ ìœ„ì¹˜ ì£¼ë³€ 500m ê²€ìƒ‰ ì¤‘ì§€
                            navigator.geolocation.clearWatch(watchId); // ìœ„ì¹˜ ì¶”ì  ì¤‘ì§€
                            watchId = null; // ID ì´ˆê¸°í™”
                        }
                        markers.clearLayers();
                        hotmarkers.clearLayers();
                        map.setView([enter_result.mapy, enter_result.mapx], 16);
                        // í–‰ì‚¬ì¥ ë§ˆí‚¹
                        var hotmarker = L.marker([enter_result.mapy, enter_result.mapx], { icon: hotIcon }).addTo(hotmarkers);
                        hotmarker.on('click', function() {
                            const conid = encodeURIComponent(enter_result.contentid)
                            window.location.href = `post1.html?contentid=${conid}`
                        });
                        // í–‰ì‚¬ì¥ ì£¼ë³€ ë§ˆí‚¹
                        fetchAndProcessParkingData(enter_result.mapy, enter_result.mapx)
                            .then(parkingData => {
                                if (parkingData) {
                                    console.log("ì£¼ì°¨ì¥ ë°ì´í„°:", parkingData);
                                    addParkingMarkers(parkingData); // ë°›ì€ ë°ì´í„°ë¥¼ ì§€ë„ì— ë§ˆì»¤ë¡œ ì¶”ê°€
                                } else {
                                    console.error("ì£¼ì°¨ì¥ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                                }
                            })
                            .catch(error => console.error("Error:", error));
                    } else {
                        // ì§€ë²ˆì¸ ê²½ìš°ì—ëŠ” ì§€ë„ë§Œ ì˜®ê¸°ê¸°ë§Œ í•˜ê³  ì£¼ë³€ ì£¼ì°¨ì¥ ë‚˜íƒ€ë‚´ê¸°
                        markers.clearLayers(); // ê¸°ì¡´ ë§ˆì»¤ ì‚­ì œ
                        hotmarkers.clearLayers();
                        map.setView([enter_result.lat, enter_result.lon], 16); // ì§€ë„ ìœ„ì¹˜ ì´ë™
                        fetchAndProcessParkingData(enter_result.lat, enter_result.lon)
                            .then(parkingData => {
                                if (parkingData) {
                                    console.log("ì£¼ì°¨ì¥ ë°ì´í„°:", parkingData);
                                    addParkingMarkers(parkingData); // ë°›ì€ ë°ì´í„°ë¥¼ ì§€ë„ì— ë§ˆì»¤ë¡œ ì¶”ê°€
                                } else {
                                    console.error("ì£¼ì°¨ì¥ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                                }
                            })
                            .catch(error => console.error("Error:", error));
                    }
                } else {
                    alert("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
                }
                console.log(enter_result);
            } else {
                alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            }
        }
        
        // ì‹¤ì œ ê²€ìƒ‰ ë™ì‘ (API í˜¸ì¶œ ë˜ëŠ” ë°ì´í„° í•„í„°ë§)
        async function performSearch(query) {
            console.log(`"${query}"ë¡œ ${selectedValue} ê²€ìƒ‰ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.`);
            // ë§Œì•½ selectedValueê°€ park ë©´ ì£¼ì°¨ì¥ ì—”ë“œí¬ì¸íŠ¸ë¡œ hotplaceë©´ í•«í”Œë¡œ
            // TODO
            try {
                const response = await fetch(`https://parkingissue.online/api/search?searchWord=${encodeURIComponent(query)}&searchClass=${encodeURIComponent(selectedValue)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    cache: "no-store",
                });
        
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                return data
            } catch (error) {
                return {
                    status: "error",
                    message: error.message,
                };
            }
        }
    </script>
    <!-- ê²€ìƒ‰ì°½ ê¸°ëŠ¥ -->
    <script src="assets/js/form.js"></script>
</body>
</html>